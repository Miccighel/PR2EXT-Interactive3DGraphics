<html>
	<head>
		<title>Interactive 3D Graphics - Project 1 - 3D Charts</title>
		<style>		
		body {
			font-family: Monospace;
			background-color: #000000;
			margin: 0px;
			overflow: hidden;
		}		
		canvas { 
			width: 100%; 
			height: 100%;
		}	
	</style>
		<script src="lib/Three.min.js"></script>
		<script src="lib/OrbitAndPanControls.js"></script>
		<script src="lib/JQuery.min.js"></script>
        <!-- This file contains our custom functions for the project. -->
        <script src="lib/Functions.js"></script>
        <script src="lib/Tween.min.js"></script>
        <script src="lib/Dat.gui.js"></script>
        <script src="lib/helvetiker_regular.typeface.js"></script>
	</head>
	<body>

    <script type="text/x-glsl" id="vertex">
		varying vec3 transformedNormal;
		varying vec3 pointPosition;
		varying vec3 lightVector;
		uniform vec3 pointLightPosition;

		void main()
		{
			transformedNormal = normalMatrix * normal;
			pointPosition = (modelViewMatrix * vec4( position, 1.0 )).xyz;
			vec4 lPosition = viewMatrix * vec4( pointLightPosition, 1.0 );
			lightVector = lPosition.xyz - pointPosition;
			gl_Position = projectionMatrix * vec4(pointPosition,1.0);
		}
		</script>

    <script type="text/x-glsl" id="ct-fragment">
			uniform vec3 lightPower;
			uniform vec3 ambient;
			uniform vec3 Kd; // surface diffuse color
			uniform vec3 Ks; // surface specular color: equal to R_F(0)
			uniform float m; // material roughness (average slope of microfacets)
			uniform float s; // percentage of incoming light which is specularly reflected

			varying vec3 transformedNormal;
			varying vec3 pointPosition;
			varying vec3 lightVector;

			#define PI 3.14159265

			// compute the geometry term
			float G(float NdotH, float NdotV, float VdotH, float NdotL)
			{
				float G1 = 2.0 * NdotH * NdotV / VdotH;
				float G2 = 2.0 * NdotH * NdotL / VdotH;
				return min( 1.0, min( G1, G2 ));
			}

			// compute Fresnel reflection term
			vec3 R_F(float VdotH) {
				return Ks + (1.0 - Ks)*pow(1.0-VdotH, 5.0);
			}

			// compute the normal distribution function, based on Beckmann distribution
			float Beckmann(float NdotH){
				float A = 1.0 / (pow(m,2.0)+pow(NdotH,4.0)*PI);
				float B = exp( - pow( tan(acos(NdotH)) , 2.0) / pow(m,2.0));
				return A*B;
			}

			void main()
			{
				vec3  n      		 	= normalize( transformedNormal );
				vec3  v         		= normalize( -pointPosition );
				vec3  l         		= normalize(  lightVector );
				vec3  h          		= normalize( v+l );
				float  NdotH    		= max(0.0, dot( n, h ));
				float  VdotH     		= max(0.0, dot( v, h ));
				float  NdotV 			= max(0.0, dot( n, v ));
				float  NdotL 			= max(0.0, dot( n, l ));
				// specular BRDF
				vec3 Specular = (Beckmann(NdotH) * G(NdotH, NdotV, VdotH, NdotL) * R_F(VdotH)) / ( NdotL* NdotV);
				vec3 beta = lightPower / ( 4.0  * PI * pow( length(lightVector),2.0) );
				gl_FragColor = vec4(beta * NdotL * ((1.0-s)*Kd + s*Specular) + ambient*Kd, 1.0);
			}
		</script>

		<script>
            
            /* SCENE SETUP */
            
            // Setup of the scene, including instructions to move and zoom in/out the camera around the objects of the scene
            var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );            
			var renderer = new THREE.WebGLRenderer({antialias:true});            
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor( 0xf0f0f0 );
			document.body.appendChild( renderer.domElement ); 
            controls = new THREE.OrbitAndPanControls( camera, renderer.domElement );
            controls.addEventListener( 'change', render );
            window.addEventListener( 'resize', onWindowResize, false );

            /* GUI SETUP */
            
            // Setup of the GUI to control the properties of the random table and graphs            
            var params = {
                Rows : 6,
                Columns : 6,
                Max_Value : 20,
                Chart : 'Main Page',
                Visual_Set: 'Color Set 1',
                Reset_Highlight:function(){},
                Row_To_Show: 1
            } 
            
            var gui = new dat.GUI();
            
            // Panel with options to control the attributes of the table
            var tableFolder = gui.addFolder('Table');
            var rowsNumber = tableFolder.add(params, 'Rows').min(1).max(6).step(1);
            var columnsNumber = tableFolder.add(params, 'Columns').min(1).max(6).step(1);            
            var maxValue = tableFolder.add(params, 'Max_Value').min(2).max(20).step(1);
            tableFolder.open();
            
            // Panel with options to control the attributes of the graphs
            var chartFolder = gui.addFolder('Chart');
            var chart = chartFolder.add(params, 'Chart',['Main Page','Pie Chart','Bar Chart','Area Chart']);
            var visualSet = chartFolder.add(params, 'Visual_Set',['Color Set 1','Color Set 2', 'Material Set 1','Material Set 2']);
            var reset = chartFolder.add(params, 'Reset_Highlight');
            chartFolder.open();    
            
            /* Additional option is a panel of options to use with pie chart; it allows to the user 
            to select the row to show in pie chart*/
            var additionalOptions = gui.addFolder("Additional Options");            
            var rowToShow = additionalOptions.add(params, 'Row_To_Show').min(1).max(params.Rows).step(1); 
                         
            /* Every time that the number of random rows is changed, 
            the new max value for "row to show" option is updated */
            rowsNumber.onChange(function(value) {
                rowToShow.max(params.Rows);    
            });            
            
            // The first time, the color set menu isn't shown
            var visualSetSelector = 'div.dg li.folder:nth-child(2) li:nth-child(3)';
            $(visualSetSelector).hide();
            
            // We use JQuery to handle GUI controls 
            
            // If main page is selected, the reset button isn't shown 
            var resetSelector = 'div.dg li.folder:nth-child(2) li:nth-child(4)';
            $(resetSelector).hide();
            
            // If pie chart isn't selected, the panel with additional options isn't shown
            var additionalOptionsSelector = 'div.dg li.folder:nth-child(3)';
            $(additionalOptionsSelector).hide();
            additionalOptions.open();            
               
            /* INTRO TEXT SETUP */
            
            showIntroText();     
                        
            /* MATERIAL SETUP */
            
            // Set up of the visual sets that can be selected by the user
            var visuals = new Array();
            // A default color set is provided
            visuals.push(0x00ff00);
            visuals.push(0xffff00);
            visuals.push(0xFF0049);
            visuals.push(0x0E28E8);
            visuals.push(0x4B0082);
            visuals.push(0x30D5C8);

            /* LIGHT SETUP */

            var spotLight1;
            var spotLight2;
            var spotLight3;

            /* UNIFORM SETUP */

            var uniforms;

            /* DATA SETUP */
            
            // Data matrix is loaded with default data
            data = new Array();
            data = generateData(params.Rows,params.Columns,1,params.Max_Value);
        
            /* CHART SETUP */             
            
            chart.onChange(function (value){
                
                // This call loads the hightlight feature for the chart
                loadHighlight();
                /* This call changes the color set and redraw the chart
                If there aren't changes on the color set, the chart is shown with the default colors.*/
                loadChartMaterial();

                // As soon as the first chart is made, the color set button is shown                
                $(visualSetSelector).show();
                
                switch(params.Chart){
                        
                    case 'Pie Chart':
                        // The panel with the additional options for the pie chart is shown, the reset button isn't shown
                        $(additionalOptionsSelector).show();
                        $(resetSelector).show();
                        // The scene is cleared
                        scene = new THREE.Scene();
                        showPieChart();
                        camera.position.z=25;   
                        camera.position.y=23; 
                        camera.position.x=10;                     
                    break;
                        
                    case 'Bar Chart':
						// The panel with the additional options for the pie chart is hidden, the reset button is shown
                        $(additionalOptionsSelector).hide();
                        $(resetSelector).show();
						// The scene is cleared						
                        scene = new THREE.Scene();
                        showBarChart();
                        camera.position.z=25;   
                        camera.position.y=23; 
                        camera.position.x=10;                       
                    break;
                        
                    case 'Area Chart':
						// The panel with the additional options for the pie chart is hidden, the reset button is shown
                        $(additionalOptionsSelector).hide();
                        $(resetSelector).show();
						// The scene is cleared
						scene = new THREE.Scene();
                        showAreaChart();
                        camera.position.z=25;   
                        camera.position.y=23; 
                        camera.position.x=10;
                    break;            
                        
                    case 'Main Page': 
                        $(resetSelector).hide();
                        showIntroText();
						// The panel with the additional options for the pie chart is hidden
                        $(additionalOptionsSelector).hide();					
                     break;
                }

                // Management of the reset button; it shows again the same chart
                reset.onChange(function (value){
                    switch(params.Chart){
                        case 'Pie Chart':
                            showPieChart();
                        break;
                        case 'Bar Chart':
                            showBarChart();
                        break;                            
                        case 'Area Chart':
                            showAreaChart();
                        break;                        
                    }                    
                });                
            });

            animate();
            render();

		</script>
	</body>
</html>